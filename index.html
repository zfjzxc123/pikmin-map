<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pikmin Bloom é£¾å“åœ°åœ–</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .custom-marker { background: transparent; border: none; }
        
        /* Animation for modal */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        /* Custom scrollbar for sidebar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Toast Animation */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        .toast-visible {
            animation: fadeInOut 3s forwards;
        }
        
        /* Loading Pill Animation */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen w-full flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-sm z-20 px-4 py-3 flex justify-between items-center flex-shrink-0">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gradient-to-br from-lime-400 to-green-600 rounded-full flex items-center justify-center text-white shadow-sm font-bold text-sm">
                PK
            </div>
            <h1 class="font-bold text-lg text-gray-800 tracking-tight">Pikmin é£¾å“åœ°åœ–</h1>
        </div>
        <div class="flex gap-2">
            <button id="filterToggleBtn" class="p-2 rounded-full bg-gray-100 text-gray-600 md:hidden hover:bg-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
            </button>
            <button id="addPointBtn" class="flex items-center gap-1 px-4 py-2 rounded-full font-medium transition-all shadow-sm bg-blue-500 hover:bg-blue-600 text-white">
                <svg id="addIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span id="addBtnText">æ–°å¢åœ°é»</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 relative overflow-hidden">
        <!-- Sidebar (Filter) -->
        <div id="sidebar" class="absolute md:relative z-20 top-0 left-0 h-full bg-white shadow-lg md:shadow-none w-64 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col border-r border-gray-200">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">é£¾å“åˆ†é¡</h2>
                <p class="text-xs text-gray-400">é»æ“Šåˆ†é¡ä»¥éæ¿¾åœ°åœ–ä¸Šçš„é»</p>
            </div>
            <div id="categoryList" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Categories will be injected here JS -->
            </div>
        </div>

        <!-- Map Area -->
        <div class="flex-1 relative h-full w-full">
            
            <!-- Adding Mode Instruction Banner -->
            <div id="instructionBanner" class="hidden absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg text-sm font-medium animate-bounce pointer-events-none">
                ğŸ‘‡ è«‹åœ¨åœ°åœ–ä¸Šé»æ“Šä½ ç™¼ç¾é£¾å“çš„ä½ç½®
            </div>

            <!-- Data Loading Indicator (Non-blocking) -->
            <div id="dataLoadingIndicator" class="absolute top-4 right-4 z-[500] bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-md flex items-center gap-2 text-xs font-medium text-blue-600 border border-blue-100 transition-opacity duration-300">
                <div class="w-3 h-3 border-2 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                é€£ç·šåŒæ­¥ä¸­...
            </div>

            <!-- Map Container -->
            <div id="map"></div>

            <!-- Add Point Form (Modal) -->
            <div id="addModal" class="hidden absolute bottom-0 left-0 w-full bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.1)] rounded-t-2xl z-[1001] p-6 animate-slide-up">
                <div class="max-w-md mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-gray-800">æ–°å¢é£¾å“é»</h3>
                        <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>

                    <form id="addPointForm" class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">åœ°é»åç¨±</label>
                            <input required id="pointName" type="text" placeholder="ä¾‹å¦‚ï¼šå¤§å®‰æ£®æ—å…¬åœ’å…¥å£" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">é£¾å“é¡åˆ¥</label>
                            <select id="pointCategory" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm appearance-none">
                                <!-- Options injected by JS -->
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">å‚™è¨» (é¸å¡«)</label>
                            <textarea id="pointDesc" placeholder="ä¾‹å¦‚ï¼šéœ€è¦èµ°åˆ°æ¹–é‚Šæ‰åµæ¸¬å¾—åˆ°" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm resize-none h-20"></textarea>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md hover:shadow-lg transition-all transform active:scale-95">
                            ç¢ºèªæ–°å¢
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-[90%] max-w-sm transform scale-95 transition-transform duration-300">
            <div class="flex flex-col items-center text-center">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
                <p class="text-sm text-gray-500 mb-6">åˆªé™¤å¾Œæ­¤åœ°é»å°‡ç„¡æ³•å¾©åŸã€‚</p>
                <div class="flex gap-3 w-full">
                    <button id="cancelDeleteBtn" class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-colors">å–æ¶ˆ</button>
                    <button id="confirmDeleteBtn" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl font-medium shadow-md transition-transform active:scale-95">åˆªé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Redirect to Map Confirmation Modal -->
    <div id="mapRedirectModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-[90%] max-w-sm transform scale-95 transition-transform duration-300">
            <div class="flex flex-col items-center text-center">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">å·²è¤‡è£½åœ°å€</h3>
                <p class="text-sm text-gray-500 mb-6">æ˜¯å¦è¦é–‹å•Ÿ Google Maps é€²è¡Œå°èˆªï¼Ÿ</p>
                <div class="flex gap-3 w-full">
                    <button id="cancelRedirectBtn" class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-colors">ä¸ç”¨äº†</button>
                    <button id="confirmRedirectBtn" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium shadow-md transition-transform active:scale-95">é–‹å•Ÿåœ°åœ–</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-[3000] flex items-center gap-2 opacity-0 pointer-events-none transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
        <span id="toastMsg" class="font-medium text-sm">å·²è¤‡è£½åœ°å€</span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Configuration ---
        const CATEGORIES = {
            // é¤é£²
            restaurant: { id: 'restaurant', label: 'é¤å»³', icon: 'ğŸ½ï¸' },
            cafe: { id: 'cafe', label: 'å’–å•¡å»³', icon: 'â˜•' },
            sweetshop: { id: 'sweetshop', label: 'ç”œé»åº—', icon: 'ğŸ°' },
            bakery: { id: 'bakery', label: 'éºµåŒ…åº—', icon: 'ğŸ¥–' },
            hamburger: { id: 'hamburger', label: 'æ¼¢å ¡åº—', icon: 'ğŸ”' },
            italian: { id: 'italian', label: 'ç¾©å¼é¤å»³', icon: 'ğŸ' },
            ramen: { id: 'ramen', label: 'æ‹‰éºµåº—', icon: 'ğŸœ' },
            sushi: { id: 'sushi', label: 'å£½å¸é¤å»³', icon: 'ğŸ£' },
            curry: { id: 'curry', label: 'å’–å“©é¤å»³', icon: 'ğŸ›' },
            korean: { id: 'korean', label: 'éŸ“åœ‹é¤å»³', icon: 'ğŸ¥˜' },
            mexican: { id: 'mexican', label: 'å¢¨è¥¿å“¥é¤å»³', icon: 'ğŸŒ®' },
            
            // è³¼ç‰©
            convenience: { id: 'convenience', label: 'ä¾¿åˆ©åº—', icon: 'ğŸª' },
            supermarket: { id: 'supermarket', label: 'è¶…å¸‚', icon: 'ğŸ„' },
            pharmacy: { id: 'pharmacy', label: 'è—¥å±€', icon: 'ğŸ’Š' },
            cosmetics: { id: 'cosmetics', label: 'åŒ–å¦å“å•†åº—', icon: 'ğŸ’„' },
            appliance: { id: 'appliance', label: 'é›»å™¨è¡Œ', icon: 'ğŸ“º' },
            hardware: { id: 'hardware', label: 'äº”é‡‘è¡Œ', icon: 'ğŸ”¨' },
            clothing_store: { id: 'clothing_store', label: 'æœé£¾åº—', icon: 'ğŸ‘—' },
            
            // è¨­æ–½/åœ°é»
            hair_salon: { id: 'hair_salon', label: 'ç¾å®¹é™¢', icon: 'âœ‚ï¸' },
            post_office: { id: 'post_office', label: 'éƒµå±€', icon: 'ğŸ“®' },
            library: { id: 'library', label: 'åœ–æ›¸é¤¨', icon: 'ğŸ“š' },
            art_gallery: { id: 'art_gallery', label: 'ç¾è¡“é¤¨', icon: 'ğŸ¨' },
            stadium: { id: 'stadium', label: 'é«”è‚²é¤¨', icon: 'ğŸŸï¸' },
            theme_park: { id: 'theme_park', label: 'ä¸»é¡Œæ¨‚åœ’', icon: 'ğŸ¡' },
            zoo: { id: 'zoo', label: 'å‹•ç‰©åœ’', icon: 'ğŸ¦' },
            laundromat: { id: 'laundromat', label: 'è‡ªåŠ©æ´—è¡£åº—', icon: 'ğŸ§º' },
            university: { id: 'university', label: 'å¤§å­¸å’Œå­¸é™¢', icon: 'ğŸ“' },
            hotel: { id: 'hotel', label: 'é£¯åº—', icon: 'ğŸ¨' },
            movie_theater: { id: 'movie_theater', label: 'é›»å½±é™¢', icon: 'ğŸ¬' },
            shrine: { id: 'shrine', label: 'ç¥ç¤¾å’Œå¯ºå»Ÿ', icon: 'â›©ï¸' },

            // äº¤é€š
            train_station: { id: 'train_station', label: 'è»Šç«™', icon: 'ğŸšƒ' },
            bus_stop: { id: 'bus_stop', label: 'å…¬è»Šç«™', icon: 'ğŸš' },
            airport: { id: 'airport', label: 'æ©Ÿå ´', icon: 'âœˆï¸' },
            bridge: { id: 'bridge', label: 'æ©‹æ¢', icon: 'ğŸŒ‰' },

            // æˆ¶å¤–/è‡ªç„¶
            park: { id: 'park', label: 'å…¬åœ’', icon: 'ğŸ€' },
            forest: { id: 'forest', label: 'æ£®æ—', icon: 'ğŸŒ²' },
            waterside: { id: 'waterside', label: 'æ°´é‚Š', icon: 'ğŸ’§' },
            beach: { id: 'beach', label: 'æµ·ç˜', icon: 'ğŸ–ï¸' },
            mountain: { id: 'mountain', label: 'å±±ä¸˜', icon: 'â›°ï¸' },
            roadside: { id: 'roadside', label: 'è·¯é‚Š', icon: 'ğŸ›£ï¸' },
            
            other: { id: 'other', label: 'å…¶ä»–', icon: 'ğŸ“' },
        };

        const firebaseConfig = {
          apiKey: "AIzaSyBNSPMyjfD9rOyXnamWhc7s_lmUtQ9M-Rg",
          authDomain: "pikminmap.firebaseapp.com",
          projectId: "pikminmap",
          storageBucket: "pikminmap.firebasestorage.app",
          messagingSenderId: "1078921171157",
          appId: "1:1078921171157:web:f082768c98df91586b925c",
          measurementId: "G-JECZZH6KS4"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let map;
        let markersLayer;
        let allPoints = [];
        let currentUser = null;
        let isAddingMode = false;
        let tempMarker = null;
        let currentFilter = 'all';
        let pointToDeleteId = null;
        let redirectLatLng = null; // Store lat/lng for redirection

        // --- Initialization ---
        async function init() {
            initMap();
            initUI();
            
            // Authentication
            try {
                await signInAnonymously(auth);
            } catch (err) {
                console.error("Auth Error", err);
                if (err.code === 'auth/operation-not-allowed') {
                    alert("éŒ¯èª¤ï¼šè«‹åˆ° Firebase Console é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ (Anonymous)ã€åŠŸèƒ½ã€‚\n\nè·¯å¾‘ï¼šBuild > Authentication > Sign-in method > Anonymous > Enable");
                } else {
                    alert("ç™»å…¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Console éŒ¯èª¤è¨Šæ¯ã€‚\né€šå¸¸æ˜¯å› ç‚º Firebase å°ˆæ¡ˆæœªå•Ÿç”¨ Authentication åŠŸèƒ½ã€‚");
                }
            }

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    startListening();
                }
            });
        }

        function initMap() {
            // Setup bounds for Taiwan area to restrict view
            const taiwanBounds = L.latLngBounds(
                [20.0, 118.0], // Southwest corner
                [27.0, 123.0]  // Northeast corner
            );

            // Default center (Taipei 101)
            map = L.map('map', { 
                zoomControl: false,
                minZoom: 7, // Prevent zooming out too far
                maxBounds: taiwanBounds, // Restrict panning
                maxBoundsViscosity: 1.0 // Strong elasticity
            }).setView([25.0339, 121.5644], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
            }).addTo(map);

            // Move zoom control to bottom right
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);

            // Map Click Event
            map.on('click', (e) => {
                if (!isAddingMode) return;

                const latlng = e.latlng;
                
                // Remove previous temp marker if exists
                if (tempMarker) map.removeLayer(tempMarker);

                // Create temp marker
                const defaultIcon = createLeafletIcon(CATEGORIES.restaurant.icon);
                tempMarker = L.marker(latlng, { icon: defaultIcon, opacity: 0.7 }).addTo(map);

                // Show Modal
                document.getElementById('addModal').classList.remove('hidden');
                document.getElementById('instructionBanner').classList.add('hidden');
                
                // Set default select to restaurant
                document.getElementById('pointCategory').value = 'restaurant';
                updateTempMarkerIcon('restaurant');
            });
        }

        function initUI() {
            // Populate Categories in Sidebar & Select
            const catListEl = document.getElementById('categoryList');
            const selectEl = document.getElementById('pointCategory');

            // "All" button
            const allBtn = createCategoryBtn('all', { label: 'å…¨éƒ¨é¡¯ç¤º', icon: 'ğŸ”' }, true);
            catListEl.appendChild(allBtn);

            Object.values(CATEGORIES).forEach(cat => {
                // Sidebar button
                catListEl.appendChild(createCategoryBtn(cat.id, cat));
                
                // Select option
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.icon} ${cat.label}`;
                selectEl.appendChild(option);
            });

            // Filter Toggle (Mobile)
            document.getElementById('filterToggleBtn').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('-translate-x-full');
            });

            // Add Point Button
            document.getElementById('addPointBtn').addEventListener('click', toggleAddMode);

            // Close Modal
            document.getElementById('closeModalBtn').addEventListener('click', () => {
                document.getElementById('addModal').classList.add('hidden');
                if (tempMarker) map.removeLayer(tempMarker);
                tempMarker = null;
                // Re-show banner if still in adding mode
                if (isAddingMode) document.getElementById('instructionBanner').classList.remove('hidden');
            });

            // Form Submit
            document.getElementById('addPointForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || !tempMarker) return;

                const name = document.getElementById('pointName').value;
                const cat = document.getElementById('pointCategory').value;
                const desc = document.getElementById('pointDesc').value;
                const latlng = tempMarker.getLatLng(); // Capture data before reset

                // 1. Close UI immediately (Optimistic UX)
                toggleAddMode(); 
                document.getElementById('addPointForm').reset();
                
                showToast("æ­£åœ¨å„²å­˜...");

                try {
                    // Simplified collection path for personal project
                    await addDoc(collection(db, 'pikmin_spots'), {
                        lat: latlng.lat,
                        lng: latlng.lng,
                        name: name,
                        category: cat,
                        description: desc,
                        createdBy: currentUser.uid,
                        createdAt: serverTimestamp()
                    });
                    
                    showToast("æ–°å¢æˆåŠŸï¼");
                    // Note: No need to reset UI here as we did it optimistically

                } catch (error) {
                    console.error("Error adding doc", error);
                    if (error.code === 'permission-denied') {
                         alert("âš ï¸ å¯«å…¥å¤±æ•—ï¼šæ¬Šé™ä¸è¶³ã€‚\n\nè«‹æª¢æŸ¥ Firebase Console > Firestore Database > Rulesï¼Œç¢ºä¿è¦å‰‡å…è¨± request.auth != nullã€‚");
                    }
                    showToast("æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                    // In a real app we might want to restore the form state here
                }
            });

            // Update temp marker when category changes in form
            selectEl.addEventListener('change', (e) => {
                if (tempMarker) {
                   updateTempMarkerIcon(e.target.value);
                }
            });

            // Delete Modal Handlers
            document.getElementById('cancelDeleteBtn').addEventListener('click', cancelDelete);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);

            // Redirect Modal Handlers
            document.getElementById('cancelRedirectBtn').addEventListener('click', cancelRedirect);
            document.getElementById('confirmRedirectBtn').addEventListener('click', confirmRedirect);
        }

        // --- Logic Helper Functions ---

        function startListening() {
            // Simplified collection path for personal project
            const q = query(collection(db, 'pikmin_spots'));
            onSnapshot(q, (snapshot) => {
                allPoints = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPoints();
                // Hide loading pill once data is loaded
                const loader = document.getElementById('dataLoadingIndicator');
                if (loader) loader.classList.add('opacity-0', 'pointer-events-none');
                
                updateCounts();
            }, (err) => {
                console.error("Snapshot error", err);
                const loader = document.getElementById('dataLoadingIndicator');
                if (loader) {
                     loader.innerHTML = '<span class="text-red-500">è®€å–å¤±æ•—</span>';
                }
                
                // Specific handling for permission errors
                if (err.code === 'permission-denied') {
                    alert("âš ï¸ è³‡æ–™åº«æ¬Šé™ä¸è¶³ï¼\n\næ‚¨ä¼¼ä¹æˆåŠŸç™»å…¥äº†ï¼Œä½†è¢«è³‡æ–™åº«æ‹’çµ•è®€å–ã€‚\nè«‹å›åˆ° Firebase Console > Firestore Database > Rules (è¦å‰‡)ï¼Œç¢ºèªæ‚¨å·²å°‡è¦å‰‡æ”¹ç‚ºï¼š\nallow read, write: if request.auth != null;");
                }
            });
        }

        // --- Address Copy & Redirect Logic ---
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            
            toast.classList.remove('toast-visible');
            void toast.offsetWidth; // Trigger reflow
            
            toastMsg.textContent = message;
            toast.classList.add('toast-visible');
        }

        function copyToClipboard(text) {
            const textarea = document.createElement("textarea");
            textarea.value = text;
            textarea.style.position = "fixed";
            textarea.style.left = "-9999px";
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand("copy");
            } catch (err) {
                console.error("Fallback copy failed", err);
            }
            
            document.body.removeChild(textarea);
        }

        function promptRedirect(lat, lng) {
            redirectLatLng = { lat, lng };
            const modal = document.getElementById('mapRedirectModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function cancelRedirect() {
            const modal = document.getElementById('mapRedirectModal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                redirectLatLng = null;
            }, 300);
        }

        function confirmRedirect() {
            if (!redirectLatLng) return;
            // Google Maps URL Scheme that works on both web and mobile apps
            const url = `https://www.google.com/maps/search/?api=1&query=${redirectLatLng.lat},${redirectLatLng.lng}`;
            window.open(url, '_blank');
            cancelRedirect();
        }

        async function handleCopyAddress(lat, lng) {
            // Optimization: Prompt immediately for redirection to avoid waiting for API
            promptRedirect(lat, lng);

            showToast("æ­£åœ¨å–å¾—åœ°å€...");
            
            try {
                // Fetch address from OSM Nominatim
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, {
                    headers: { 'Accept-Language': 'zh-TW' }
                });
                
                if (!response.ok) throw new Error("Network response was not ok");
                
                const data = await response.json();
                
                let addressToCopy = "";
                if (data && data.display_name) {
                    addressToCopy = data.display_name;
                } else {
                    addressToCopy = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                }

                copyToClipboard(addressToCopy);
                showToast("å·²è¤‡è£½åœ°å€");

                // Note: We already prompted redirect at the start, no need to prompt again

            } catch (error) {
                console.error("Geocoding failed", error);
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                copyToClipboard(mapLink);
                showToast("å·²è¤‡è£½åœ°åœ–é€£çµ");
                
                // Note: We already prompted redirect at the start
            }
        }

        // --- Existing Helper Functions ---

        function promptDelete(id) {
            pointToDeleteId = id;
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function cancelDelete() {
            const modal = document.getElementById('deleteModal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                pointToDeleteId = null;
            }, 300);
        }

        async function confirmDelete() {
            if (!pointToDeleteId) return;
            
            // 1. Close UI immediately (Optimistic UX)
            const idToDelete = pointToDeleteId;
            cancelDelete();
            
            showToast("æ­£åœ¨åˆªé™¤...");

            try {
                // Simplified collection path for personal project
                const docRef = doc(db, 'pikmin_spots', idToDelete);
                await deleteDoc(docRef);
                showToast("åˆªé™¤æˆåŠŸ");
            } catch (error) {
                console.error("Error removing document: ", error);
                showToast("åˆªé™¤å¤±æ•—");
            }
        }

        function renderPoints() {
            markersLayer.clearLayers();
            
            const pointsToShow = currentFilter === 'all' 
                ? allPoints 
                : allPoints.filter(p => p.category === currentFilter);

            pointsToShow.forEach(p => {
                const cat = CATEGORIES[p.category] || CATEGORIES.other;
                const icon = createLeafletIcon(cat.icon);
                
                const container = document.createElement('div');
                container.className = "font-sans text-center min-w-[160px]";
                
                container.innerHTML = `
                    <div class="text-3xl mb-1">${cat.icon}</div>
                    <h3 class="font-bold text-gray-800 text-sm mb-1">${p.name}</h3>
                    <div class="text-xs text-blue-600 bg-blue-50 inline-block px-2 py-0.5 rounded-full mb-3">${cat.label}</div>
                    ${p.description ? `<p class="text-xs text-gray-500 text-left border-t border-gray-100 pt-2 mb-2">${p.description}</p>` : ''}
                `;

                // Wrapper for buttons
                const btnWrapper = document.createElement('div');
                btnWrapper.className = "border-t border-gray-100 pt-2 flex flex-col gap-1";

                // Copy Address Button
                const copyBtn = document.createElement('button');
                copyBtn.className = "flex items-center justify-center gap-1.5 w-full py-1.5 text-xs font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 rounded-md transition-colors";
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    è¤‡è£½åœ°å€
                `;
                copyBtn.onclick = (e) => {
                    e.stopPropagation();
                    handleCopyAddress(p.lat, p.lng);
                };
                btnWrapper.appendChild(copyBtn);

                // Delete Button (Only for authenticated user in this demo)
                if (currentUser) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = "flex items-center justify-center gap-1.5 w-full py-1 text-xs text-red-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors mt-1";
                    deleteBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        åˆªé™¤åœ°é»
                    `;
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        promptDelete(p.id);
                    };
                    btnWrapper.appendChild(deleteBtn);
                }

                container.appendChild(btnWrapper);

                const marker = L.marker([p.lat, p.lng], { icon: icon }).bindPopup(container);
                markersLayer.addLayer(marker);
            });
        }

        function toggleAddMode() {
            isAddingMode = !isAddingMode;
            const btn = document.getElementById('addPointBtn');
            const btnText = document.getElementById('addBtnText');
            const banner = document.getElementById('instructionBanner');
            const sidebar = document.getElementById('sidebar');

            if (isAddingMode) {
                // Entering add mode
                btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg><span>å–æ¶ˆ</span>`;
                banner.classList.remove('hidden');
                sidebar.classList.add('-translate-x-full'); // Hide sidebar on mobile
                
                // Change cursor
                document.getElementById('map').style.cursor = 'crosshair';
            } else {
                // Exiting add mode
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span>æ–°å¢åœ°é»</span>`;
                banner.classList.add('hidden');
                document.getElementById('addModal').classList.add('hidden');
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                document.getElementById('map').style.cursor = '';
            }
        }

        function createLeafletIcon(emoji) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: white; 
                    border: 2px solid white; 
                    border-radius: 50%; 
                    width: 32px; 
                    height: 32px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                    font-size: 20px;
                ">${emoji}</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        }

        function updateTempMarkerIcon(categoryKey) {
            if (!tempMarker) return;
            const cat = CATEGORIES[categoryKey] || CATEGORIES.other;
            tempMarker.setIcon(createLeafletIcon(cat.icon));
        }

        function createCategoryBtn(id, data, isActive = false) {
            const btn = document.createElement('button');
            btn.className = `w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm transition-colors cat-btn ${isActive ? 'bg-blue-50 text-blue-700 font-medium' : 'hover:bg-gray-50 text-gray-600'}`;
            btn.dataset.id = id;
            
            const countSpan = id === 'all' 
                ? `<span class="count-badge ml-auto text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">0</span>`
                : `<span class="count-badge ml-auto text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">0</span>`;

            btn.innerHTML = `
                <div class="w-8 text-center text-lg">${data.icon}</div>
                <span>${data.label}</span>
                ${countSpan}
            `;

            btn.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.cat-btn').forEach(b => {
                    b.classList.remove('bg-blue-50', 'text-blue-700', 'font-medium');
                    b.classList.add('text-gray-600');
                });
                btn.classList.remove('text-gray-600');
                btn.classList.add('bg-blue-50', 'text-blue-700', 'font-medium');
                
                // Set Filter
                currentFilter = id;
                renderPoints();

                // On mobile, close sidebar after selection
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                }
            });

            return btn;
        }

        function updateCounts() {
            // Update All count
            const allBtn = document.querySelector(`.cat-btn[data-id="all"] .count-badge`);
            if(allBtn) allBtn.textContent = allPoints.length;

            // Update individual counts
            Object.keys(CATEGORIES).forEach(key => {
                const btn = document.querySelector(`.cat-btn[data-id="${key}"] .count-badge`);
                if(btn) {
                    const count = allPoints.filter(p => p.category === key).length;
                    btn.textContent = count;
                }
            });
        }

        // Run
        init();

    </script>
</body>
</html>
