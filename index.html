<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pikmin Bloom é£¾å“åœ°åœ–</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet MarkerCluster CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .custom-marker { background: transparent; border: none; }
        
        /* Animation for modal */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        /* Custom scrollbar for sidebar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Toast Animation */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        .toast-visible {
            animation: fadeInOut 3s forwards;
        }
        
        /* Loading Pill Animation */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* User Location Marker Pulse */
        .user-location-pulse {
            width: 16px;
            height: 16px;
            background-color: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            position: relative;
        }
        .user-location-pulse::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #3b82f6;
            transform: translate(-50%, -50%);
            z-index: -1;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        /* Cluster Customization (Optional - making it look nicer) */
        .marker-cluster-small { background-color: rgba(181, 226, 140, 0.6); }
        .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.6); }
        .marker-cluster-medium { background-color: rgba(241, 211, 87, 0.6); }
        .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }
        .marker-cluster-large { background-color: rgba(253, 156, 115, 0.6); }
        .marker-cluster-large div { background-color: rgba(241, 128, 23, 0.6); }
    </style>
</head>
<body class="bg-gray-100 h-screen w-full flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-sm z-20 px-4 py-3 flex justify-between items-center flex-shrink-0">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gradient-to-br from-lime-400 to-green-600 rounded-full flex items-center justify-center text-white shadow-sm font-bold text-sm">
                PK
            </div>
            <h1 class="font-bold text-lg text-gray-800 tracking-tight">Pikmin é£¾å“åœ°åœ–</h1>
        </div>
        <div class="flex gap-2">
            <!-- Search Button -->
            <button id="searchToggleBtn" class="p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
            <button id="filterToggleBtn" class="p-2 rounded-full bg-gray-100 text-gray-600 md:hidden hover:bg-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
            </button>
            <button id="addPointBtn" class="flex items-center gap-1 px-4 py-2 rounded-full font-medium transition-all shadow-sm bg-blue-500 hover:bg-blue-600 text-white">
                <svg id="addIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span id="addBtnText">æ–°å¢åœ°é»</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 relative overflow-hidden">
        <!-- Sidebar (Filter) -->
        <div id="sidebar" class="absolute md:relative z-20 top-0 left-0 h-full bg-white shadow-lg md:shadow-none w-64 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col border-r border-gray-200">
            <div class="p-4 border-b border-gray-100 bg-gray-50 flex flex-col gap-3">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider">é£¾å“åˆ†é¡</h2>
                    </div>
                    <!-- Mobile Only Close Sidebar Button -->
                    <button id="sidebarCloseBtn" class="md:hidden text-gray-400 p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                
                <!-- Filter Mode Toggle -->
                <div class="flex bg-gray-200 p-1 rounded-lg">
                    <button id="modeIncludeBtn" class="flex-1 py-1.5 px-2 rounded-md text-xs font-bold transition-all shadow-sm bg-white text-blue-600">
                        âœ… åªé¡¯ç¤º
                    </button>
                    <button id="modeExcludeBtn" class="flex-1 py-1.5 px-2 rounded-md text-xs font-bold transition-all text-gray-500 hover:text-gray-700">
                        ğŸš« æ’é™¤
                    </button>
                </div>
                <p class="text-[10px] text-gray-400 text-center" id="modeDesc">é»æ“Šé¡åˆ¥ä»¥é¡¯ç¤ºè©²ç¨®é¡</p>
            </div>
            
            <div id="categoryList" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Categories will be injected here JS -->
            </div>
        </div>

        <!-- Map Area -->
        <div class="flex-1 relative h-full w-full">
            
            <!-- Adding Mode Instruction Banner -->
            <div id="instructionBanner" class="hidden absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] bg-gray-800 text-white px-4 py-2 md:px-6 md:py-3 rounded-full shadow-lg text-sm font-medium animate-bounce flex items-center gap-3 whitespace-nowrap max-w-[90%] overflow-hidden">
                <span>ğŸ‘‡ é»æ“Šåœ°åœ–</span>
                <span class="w-px h-4 bg-gray-600 opacity-30"></span>
                <button id="manualInputBtn" class="text-blue-300 hover:text-white underline underline-offset-2 transition-colors">æˆ– æ‰‹å‹•è¼¸å…¥åº§æ¨™</button>
            </div>

            <!-- Data Loading Indicator (Non-blocking) -->
            <div id="dataLoadingIndicator" class="absolute top-4 right-4 z-[500] bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-md flex items-center gap-2 text-xs font-medium text-blue-600 border border-blue-100 transition-opacity duration-300">
                <div class="w-3 h-3 border-2 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                é€£ç·šåŒæ­¥ä¸­...
            </div>

            <!-- Map Container -->
            <div id="map"></div>

            <!-- Locate Me Button -->
            <button id="locateBtn" class="absolute bottom-20 right-2.5 z-[400] bg-white w-[34px] h-[34px] flex items-center justify-center rounded shadow-sm border-2 border-[rgba(0,0,0,0.2)] hover:bg-gray-50 text-gray-700 transition-colors" title="å®šä½åˆ°ç›®å‰ä½ç½®">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><crosshair cx="12" cy="12" r="10"></crosshair><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>
            </button>

            <!-- Search Modal (Top Overlay) -->
            <div id="searchModal" class="hidden absolute top-0 left-0 w-full h-full bg-white/50 backdrop-blur-sm z-[2000]">
                <div class="w-full max-w-md mx-auto bg-white shadow-lg md:rounded-b-2xl h-full md:h-auto flex flex-col">
                    <div class="p-4 border-b border-gray-100 flex items-center gap-2">
                        <svg class="text-gray-400" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input id="searchInput" type="text" placeholder="æœå°‹åœ°å€æˆ–åœ°æ¨™..." class="flex-1 outline-none text-base bg-transparent" autocomplete="off">
                        <button id="closeSearchBtn" class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div id="searchResults" class="flex-1 overflow-y-auto p-2 space-y-1 bg-gray-50 md:max-h-[60vh]">
                        <!-- Results will be injected here -->
                        <div class="p-4 text-center text-gray-400 text-sm">
                            è¼¸å…¥æ–‡å­—ä»¥æœå°‹çœŸå¯¦åœ°åœ–ä½ç½®
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Point Form (Modal) -->
            <div id="addModal" class="hidden absolute bottom-0 left-0 w-full bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.1)] rounded-t-2xl z-[1001] p-6 animate-slide-up">
                <div class="max-w-md mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modalTitle" class="font-bold text-lg text-gray-800">æ–°å¢é£¾å“é»</h3>
                        <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>

                    <form id="addPointForm" class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">åœ°é»åç¨±</label>
                            <input required id="pointName" type="text" placeholder="ä¾‹å¦‚ï¼šå¤§å®‰æ£®æ—å…¬åœ’å…¥å£" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                        </div>

                        <!-- Single Coordinate Input -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)</label>
                            <input required id="pointCoords" type="text" placeholder="ä¾‹å¦‚ï¼š25.04, 121.53 æˆ– 25Â°04'04.8&quot;N 121Â°32'27.9&quot;E" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm font-mono text-xs">
                            <p class="text-[10px] text-gray-400 mt-1">æ”¯æ´ Google Maps åº§æ¨™ (åé€²ä½) æˆ– åº¦åˆ†ç§’æ ¼å¼ (DMS)</p>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">é£¾å“é¡åˆ¥</label>
                            <select id="pointCategory" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm appearance-none">
                                <!-- Options injected by JS -->
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">å‚™è¨» (é¸å¡«)</label>
                            <textarea id="pointDesc" placeholder="ä¾‹å¦‚ï¼šéœ€è¦èµ°åˆ°æ¹–é‚Šæ‰åµæ¸¬å¾—åˆ°" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm resize-none h-20"></textarea>
                        </div>

                        <button id="modalSubmitBtn" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md hover:shadow-lg transition-all transform active:scale-95">
                            ç¢ºèªæ–°å¢
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-[90%] max-w-sm transform scale-95 transition-transform duration-300">
            <div class="flex flex-col items-center text-center">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
                <p class="text-sm text-gray-500 mb-6">åˆªé™¤å¾Œæ­¤åœ°é»å°‡ç„¡æ³•å¾©åŸã€‚</p>
                <div class="flex gap-3 w-full">
                    <button id="cancelDeleteBtn" class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-colors">å–æ¶ˆ</button>
                    <button id="confirmDeleteBtn" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl font-medium shadow-md transition-transform active:scale-95">åˆªé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Redirect to Map Confirmation Modal -->
    <div id="mapRedirectModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-[90%] max-w-sm transform scale-95 transition-transform duration-300">
            <div class="flex flex-col items-center text-center">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">å·²è¤‡è£½åœ°å€</h3>
                <p class="text-sm text-gray-500 mb-6">æ˜¯å¦è¦é–‹å•Ÿ Google Maps é€²è¡Œå°èˆªï¼Ÿ</p>
                <div class="flex gap-3 w-full">
                    <button id="cancelRedirectBtn" class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-colors">ä¸ç”¨äº†</button>
                    <button id="confirmRedirectBtn" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium shadow-md transition-transform active:scale-95">é–‹å•Ÿåœ°åœ–</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-[3000] flex items-center gap-2 opacity-0 pointer-events-none transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
        <span id="toastMsg" class="font-medium text-sm">å·²è¤‡è£½åœ°å€</span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Configuration ---
        const CATEGORIES = {
            // é¤é£²
            restaurant: { id: 'restaurant', label: 'é¤å»³', icon: 'ğŸ½ï¸' },
            cafe: { id: 'cafe', label: 'å’–å•¡å»³', icon: 'â˜•' },
            sweetshop: { id: 'sweetshop', label: 'ç”œé»åº—', icon: 'ğŸ°' },
            bakery: { id: 'bakery', label: 'éºµåŒ…åº—', icon: 'ğŸ¥–' },
            hamburger: { id: 'hamburger', label: 'æ¼¢å ¡åº—', icon: 'ğŸ”' },
            italian: { id: 'italian', label: 'ç¾©å¼é¤å»³', icon: 'ğŸ' },
            ramen: { id: 'ramen', label: 'æ‹‰éºµåº—', icon: 'ğŸœ' },
            sushi: { id: 'sushi', label: 'å£½å¸é¤å»³', icon: 'ğŸ£' },
            curry: { id: 'curry', label: 'å’–å“©é¤å»³', icon: 'ğŸ›' },
            korean: { id: 'korean', label: 'éŸ“åœ‹é¤å»³', icon: 'ğŸ¥˜' },
            mexican: { id: 'mexican', label: 'å¢¨è¥¿å“¥é¤å»³', icon: 'ğŸŒ®' },
            
            // è³¼ç‰©
            convenience: { id: 'convenience', label: 'ä¾¿åˆ©åº—', icon: 'ğŸª' },
            supermarket: { id: 'supermarket', label: 'è¶…å¸‚', icon: 'ğŸ„' },
            pharmacy: { id: 'pharmacy', label: 'è—¥å±€', icon: 'ğŸ’Š' },
            cosmetics: { id: 'cosmetics', label: 'åŒ–å¦å“å•†åº—', icon: 'ğŸ’„' },
            appliance: { id: 'appliance', label: 'é›»å™¨è¡Œ', icon: 'ğŸ“º' },
            hardware: { id: 'hardware', label: 'äº”é‡‘è¡Œ', icon: 'ğŸ”¨' },
            clothing_store: { id: 'clothing_store', label: 'æœé£¾åº—', icon: 'ğŸ‘—' },
            
            // è¨­æ–½/åœ°é»
            hair_salon: { id: 'hair_salon', label: 'ç¾å®¹é™¢', icon: 'âœ‚ï¸' },
            post_office: { id: 'post_office', label: 'éƒµå±€', icon: 'ğŸ“®' },
            library: { id: 'library', label: 'åœ–æ›¸é¤¨', icon: 'ğŸ“š' },
            art_gallery: { id: 'art_gallery', label: 'ç¾è¡“é¤¨', icon: 'ğŸ¨' },
            stadium: { id: 'stadium', label: 'é«”è‚²é¤¨', icon: 'ğŸŸï¸' },
            theme_park: { id: 'theme_park', label: 'ä¸»é¡Œæ¨‚åœ’', icon: 'ğŸ¡' },
            zoo: { id: 'zoo', label: 'å‹•ç‰©åœ’', icon: 'ğŸ¦' },
            laundromat: { id: 'laundromat', label: 'è‡ªåŠ©æ´—è¡£åº—', icon: 'ğŸ§º' },
            university: { id: 'university', label: 'å¤§å­¸å’Œå­¸é™¢', icon: 'ğŸ“' },
            hotel: { id: 'hotel', label: 'é£¯åº—', icon: 'ğŸ¨' },
            movie_theater: { id: 'movie_theater', label: 'é›»å½±é™¢', icon: 'ğŸ¬' },
            shrine: { id: 'shrine', label: 'ç¥ç¤¾å’Œå¯ºå»Ÿ', icon: 'â›©ï¸' },

            // äº¤é€š
            train_station: { id: 'train_station', label: 'è»Šç«™', icon: 'ğŸšƒ' },
            bus_stop: { id: 'bus_stop', label: 'å…¬è»Šç«™', icon: 'ğŸš' },
            airport: { id: 'airport', label: 'æ©Ÿå ´', icon: 'âœˆï¸' },
            bridge: { id: 'bridge', label: 'æ©‹æ¢', icon: 'ğŸŒ‰' },

            // æˆ¶å¤–/è‡ªç„¶
            park: { id: 'park', label: 'å…¬åœ’', icon: 'ğŸ€' },
            forest: { id: 'forest', label: 'æ£®æ—', icon: 'ğŸŒ²' },
            waterside: { id: 'waterside', label: 'æ°´é‚Š', icon: 'ğŸ’§' },
            beach: { id: 'beach', label: 'æµ·ç˜', icon: 'ğŸ–ï¸' },
            mountain: { id: 'mountain', label: 'å±±ä¸˜', icon: 'â›°ï¸' },
            roadside: { id: 'roadside', label: 'è·¯é‚Š', icon: 'ğŸ›£ï¸' },
            
            other: { id: 'other', label: 'å…¶ä»–', icon: 'ğŸ“' },
        };

        const firebaseConfig = {
          apiKey: "AIzaSyBNSPMyjfD9rOyXnamWhc7s_lmUtQ9M-Rg",
          authDomain: "pikminmap.firebaseapp.com",
          projectId: "pikminmap",
          storageBucket: "pikminmap.firebasestorage.app",
          messagingSenderId: "1078921171157",
          appId: "1:1078921171157:web:f082768c98df91586b925c",
          measurementId: "G-JECZZH6KS4"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let map;
        let markersLayer;
        let allPoints = [];
        let currentUser = null;
        let isAddingMode = false;
        let isEditingMode = false;
        let editPointId = null;
        let tempMarker = null;
        // Changed to Set for multiple selection
        let currentFilters = new Set(['all']);
        let isExcludeMode = false; // New state for exclusion logic
        let pointToDeleteId = null;
        let redirectLatLng = null; // Store lat/lng for redirection
        let userLocationMarker = null;
        let userLocationCircle = null;
        let currentUserPosition = null;
        let searchDebounceTimeout = null;

        // --- Initialization ---
        async function init() {
            initMap();
            initUI();
            
            // Authentication
            try {
                await signInAnonymously(auth);
            } catch (err) {
                console.error("Auth Error", err);
                if (err.code === 'auth/operation-not-allowed') {
                    alert("éŒ¯èª¤ï¼šè«‹åˆ° Firebase Console é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ (Anonymous)ã€åŠŸèƒ½ã€‚\n\nè·¯å¾‘ï¼šBuild > Authentication > Sign-in method > Anonymous > Enable");
                } else {
                    alert("ç™»å…¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Console éŒ¯èª¤è¨Šæ¯ã€‚\né€šå¸¸æ˜¯å› ç‚º Firebase å°ˆæ¡ˆæœªå•Ÿç”¨ Authentication åŠŸèƒ½ã€‚");
                }
            }

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    startListening();
                }
            });
        }

        function initMap() {
            // Setup bounds for Taiwan area to restrict view
            const taiwanBounds = L.latLngBounds(
                [20.0, 118.0], // Southwest corner
                [27.0, 123.0]  // Northeast corner
            );

            // Default center (Taipei 101)
            map = L.map('map', { 
                zoomControl: false,
                minZoom: 7, // Prevent zooming out too far
                maxBounds: taiwanBounds, // Restrict panning
                maxBoundsViscosity: 1.0 // Strong elasticity
            }).setView([25.0339, 121.5644], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
            }).addTo(map);

            // Move zoom control to bottom right
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Replace LayerGroup with MarkerClusterGroup
            markersLayer = L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                spiderfyOnMaxZoom: true,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    // Custom cluster icon (optional, keeping default style for now but cleaner)
                    return L.divIcon({ 
                        html: '<div><span>' + cluster.getChildCount() + '</span></div>', 
                        className: 'marker-cluster marker-cluster-small', 
                        iconSize: new L.Point(40, 40) 
                    });
                }
            }).addTo(map);

            // Map Click Event
            map.on('click', (e) => {
                if (!isAddingMode) return;

                const latlng = e.latlng;
                
                // Remove previous temp marker if exists
                if (tempMarker) map.removeLayer(tempMarker);

                // Determine default category based on filter
                let defaultCat = 'restaurant';
                if (!isExcludeMode && currentFilters.size > 0 && !currentFilters.has('all')) {
                    defaultCat = currentFilters.values().next().value;
                }

                // Create temp marker
                const defaultIcon = createLeafletIcon(CATEGORIES[defaultCat]?.icon || CATEGORIES.restaurant.icon);
                tempMarker = L.marker(latlng, { icon: defaultIcon, opacity: 0.7 }).addTo(map);

                // Show Modal
                showModal(false); // False for Add mode
                
                // Set default select to restaurant (or filter default)
                document.getElementById('pointCategory').value = defaultCat;
                updateTempMarkerIcon(defaultCat);

                // Auto fill name with default category label
                if (CATEGORIES[defaultCat]) {
                    document.getElementById('pointName').value = CATEGORIES[defaultCat].label;
                }

                // Fill coordinates input (Single line)
                document.getElementById('pointCoords').value = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
            });

            // Location Found Event
            map.on('locationfound', function(e) {
                const radius = e.accuracy;
                currentUserPosition = e.latlng; // Store location

                if (userLocationMarker) {
                    map.removeLayer(userLocationMarker);
                    map.removeLayer(userLocationCircle);
                }

                userLocationMarker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div class="user-location-pulse"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);

                userLocationCircle = L.circle(e.latlng, radius, {
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.1,
                    weight: 1
                }).addTo(map);
                
                showToast("å·²å®šä½åˆ°æ‚¨çš„ä½ç½®");
            });

            map.on('locationerror', function(e) {
                showToast("ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼š" + e.message);
            });
        }

        // Helper function to parse coordinate string
        function parseCoords(input) {
            input = input.trim();
            
            // 1. Try DMS format (e.g. 25Â°04'04.8"N 121Â°32'27.9"E)
            // Regex captures: Degrees, Minutes, Seconds, Direction
            const dmsRegex = /(\d+)[Â°\s]+(\d+)['\s]+(\d+(\.\d+)?)["\s]*([NSEWnsew])/g;
            const matches = [...input.matchAll(dmsRegex)];

            if (matches.length >= 2) {
                const parseDMS = (m) => {
                    const deg = parseFloat(m[1]);
                    const min = parseFloat(m[2]);
                    const sec = parseFloat(m[3]);
                    const dir = m[5].toUpperCase(); 
                    
                    let val = deg + min / 60 + sec / 3600;
                    if (dir === 'S' || dir === 'W') val = -val;
                    return { val, dir };
                };

                const c1 = parseDMS(matches[0]);
                const c2 = parseDMS(matches[1]);

                let lat, lng;
                if (['N', 'S'].includes(c1.dir)) {
                    lat = c1.val;
                    lng = c2.val;
                } else {
                    lng = c1.val;
                    lat = c2.val;
                }
                
                return { lat, lng };
            }

            // 2. Try Standard Decimal format (e.g. 25.0405561, 121.5393391)
            // Split by comma or space (if not DMS)
            const parts = input.split(/[, ]+/).map(s => s.trim()).filter(s => s !== '');
            if (parts.length >= 2) {
                const lat = parseFloat(parts[0]);
                const lng = parseFloat(parts[1]);
                if (!isNaN(lat) && !isNaN(lng)) {
                    return { lat, lng };
                }
            }
            
            return null;
        }

        function initUI() {
            // Populate Categories in Sidebar & Select
            const catListEl = document.getElementById('categoryList');
            const selectEl = document.getElementById('pointCategory');

            // "All" button
            const allBtn = createCategoryBtn('all', { label: 'å…¨éƒ¨é¡¯ç¤º', icon: 'ğŸ”' }, true);
            catListEl.appendChild(allBtn);

            Object.values(CATEGORIES).forEach(cat => {
                // Sidebar button
                catListEl.appendChild(createCategoryBtn(cat.id, cat));
                
                // Select option
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.icon} ${cat.label}`;
                selectEl.appendChild(option);
            });
            
            // Set initial active states
            updateCategoryButtonsState();

            // Filter Toggle (Mobile)
            document.getElementById('filterToggleBtn').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('-translate-x-full');
            });
            
            // Close Sidebar Btn (Mobile)
            document.getElementById('sidebarCloseBtn').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('-translate-x-full');
            });
            
            // Filter Mode Toggles
            document.getElementById('modeIncludeBtn').addEventListener('click', () => {
                setFilterMode(false);
            });
            document.getElementById('modeExcludeBtn').addEventListener('click', () => {
                setFilterMode(true);
            });

            // Search Handlers
            document.getElementById('searchToggleBtn').addEventListener('click', () => {
                document.getElementById('searchModal').classList.remove('hidden');
                document.getElementById('searchInput').focus();
            });

            document.getElementById('closeSearchBtn').addEventListener('click', () => {
                document.getElementById('searchModal').classList.add('hidden');
            });

            document.getElementById('searchInput').addEventListener('input', (e) => {
                const query = e.target.value.trim();
                clearTimeout(searchDebounceTimeout);
                
                if (query.length === 0) {
                    document.getElementById('searchResults').innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">è¼¸å…¥æ–‡å­—ä»¥æœå°‹çœŸå¯¦åœ°åœ–ä½ç½®</div>';
                    return;
                }

                searchDebounceTimeout = setTimeout(() => {
                    handleSearch(query);
                }, 500);
            });

            // Add Point Button
            document.getElementById('addPointBtn').addEventListener('click', toggleAddMode);

            // Locate Me Button
            document.getElementById('locateBtn').addEventListener('click', () => {
                showToast("æ­£åœ¨å®šä½ä¸­...");
                map.locate({ setView: true, maxZoom: 16 });
            });

            // Manual Input Button
            document.getElementById('manualInputBtn').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent map click if overlapping
                const center = map.getCenter();
                
                // Determine default category based on filter
                let defaultCat = 'restaurant';
                if (!isExcludeMode && currentFilters.size > 0 && !currentFilters.has('all')) {
                    defaultCat = currentFilters.values().next().value;
                }

                // Trigger the logic similar to map click
                if (tempMarker) map.removeLayer(tempMarker);
                const defaultIcon = createLeafletIcon(CATEGORIES[defaultCat]?.icon || CATEGORIES.restaurant.icon);
                tempMarker = L.marker(center, { icon: defaultIcon, opacity: 0.7 }).addTo(map);

                showModal(false);
                document.getElementById('pointCategory').value = defaultCat;
                updateTempMarkerIcon(defaultCat);

                // Auto fill name with default category label
                if (CATEGORIES[defaultCat]) {
                    document.getElementById('pointName').value = CATEGORIES[defaultCat].label;
                }
                
                document.getElementById('pointCoords').value = `${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}`;
            });

            // Coordinate inputs change listener (Real-time update)
            document.getElementById('pointCoords').addEventListener('input', (e) => {
                const coords = parseCoords(e.target.value);
                if (coords) {
                    const newLatLng = [coords.lat, coords.lng];
                    if (tempMarker) {
                        tempMarker.setLatLng(newLatLng);
                        map.setView(newLatLng); // Pan to new location
                    }
                }
            });

            // Close Modal
            document.getElementById('closeModalBtn').addEventListener('click', () => {
                document.getElementById('addModal').classList.add('hidden');
                if (tempMarker) map.removeLayer(tempMarker);
                tempMarker = null;
                isEditingMode = false;
                editPointId = null;
                // Re-show banner if still in adding mode
                if (isAddingMode) document.getElementById('instructionBanner').classList.remove('hidden');
            });

            // Form Submit
            document.getElementById('addPointForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return; // tempMarker is not strictly required if we trust inputs

                const name = document.getElementById('pointName').value;
                const cat = document.getElementById('pointCategory').value;
                const desc = document.getElementById('pointDesc').value;
                
                // Read from input
                const coordsStr = document.getElementById('pointCoords').value;
                const coords = parseCoords(coordsStr);

                if (!coords) {
                    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åº§æ¨™ï¼Œä¾‹å¦‚ï¼š25.0339, 121.5644");
                    return;
                }

                // Close UI immediately (Optimistic UX)
                const isEdit = isEditingMode; // Save state for logic
                const editId = editPointId;
                
                if (isEdit) {
                    // Close edit modal specific logic
                    document.getElementById('addModal').classList.add('hidden');
                    if (tempMarker) map.removeLayer(tempMarker);
                    tempMarker = null;
                    isEditingMode = false;
                    editPointId = null;
                } else {
                    // Close add mode
                    toggleAddMode(); 
                }
                
                document.getElementById('addPointForm').reset();
                showToast(isEdit ? "æ­£åœ¨æ›´æ–°..." : "æ­£åœ¨å„²å­˜...");

                try {
                    if (isEdit) {
                        // Update existing doc
                        const docRef = doc(db, 'pikmin_spots', editId);
                        await updateDoc(docRef, {
                            lat: coords.lat,
                            lng: coords.lng,
                            name: name,
                            category: cat,
                            description: desc,
                            updatedAt: serverTimestamp()
                        });
                        showToast("æ›´æ–°æˆåŠŸï¼");
                    } else {
                        // Create new doc
                        await addDoc(collection(db, 'pikmin_spots'), {
                            lat: coords.lat,
                            lng: coords.lng,
                            name: name,
                            category: cat,
                            description: desc,
                            createdBy: currentUser.uid,
                            createdAt: serverTimestamp()
                        });
                        showToast("æ–°å¢æˆåŠŸï¼");
                    }

                } catch (error) {
                    console.error("Error adding/updating doc", error);
                    if (error.code === 'permission-denied') {
                         alert("âš ï¸ å¯«å…¥å¤±æ•—ï¼šæ¬Šé™ä¸è¶³ã€‚\n\nè«‹æª¢æŸ¥ Firebase Console > Firestore Database > Rulesï¼Œç¢ºä¿è¦å‰‡å…è¨± request.auth != nullã€‚");
                    }
                    showToast("æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                }
            });

            // Update temp marker when category changes in form
            selectEl.addEventListener('change', (e) => {
                const val = e.target.value;
                if (tempMarker) {
                   updateTempMarkerIcon(val);
                }
                // Auto-fill name with category label
                if (CATEGORIES[val]) {
                    document.getElementById('pointName').value = CATEGORIES[val].label;
                }
            });

            // Delete Modal Handlers
            document.getElementById('cancelDeleteBtn').addEventListener('click', cancelDelete);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);

            // Redirect Modal Handlers
            document.getElementById('cancelRedirectBtn').addEventListener('click', cancelRedirect);
            document.getElementById('confirmRedirectBtn').addEventListener('click', confirmRedirect);
        }

        // --- Logic Helper Functions ---
        
        function setFilterMode(exclude) {
            isExcludeMode = exclude;
            
            // Reset filters to 'all' (meaning Show All or Hide None)
            currentFilters.clear();
            currentFilters.add('all');
            
            // Update UI buttons
            const incBtn = document.getElementById('modeIncludeBtn');
            const excBtn = document.getElementById('modeExcludeBtn');
            const desc = document.getElementById('modeDesc');
            
            if (exclude) {
                // Exclude Mode Active
                incBtn.className = "flex-1 py-1.5 px-2 rounded-md text-xs font-bold transition-all text-gray-500 hover:text-gray-700";
                excBtn.className = "flex-1 py-1.5 px-2 rounded-md text-xs font-bold transition-all shadow-sm bg-white text-red-600";
                desc.textContent = "é»æ“Šé¡åˆ¥ä»¥éš±è— (åé¸)";
            } else {
                // Include Mode Active
                incBtn.className = "flex-1 py-1.5 px-2 rounded-md text-xs font-bold transition-all shadow-sm bg-white text-blue-600";
                excBtn.className = "flex-1 py-1.5 px-2 rounded-md text-xs font-bold transition-all text-gray-500 hover:text-gray-700";
                desc.textContent = "é»æ“Šé¡åˆ¥ä»¥é¡¯ç¤ºè©²ç¨®é¡";
            }
            
            updateCategoryButtonsState();
            renderPoints();
        }

        async function handleSearch(query) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm"><div class="w-4 h-4 border-2 border-gray-300 border-t-blue-500 rounded-full animate-spin mx-auto mb-2"></div>æœå°‹ä¸­...</div>';

            const results = [];

            // 2. Search Online (OSM Nominatim)
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=zh-TW&limit=5&countrycodes=tw`);
                const onlineMatches = await response.json();
                
                onlineMatches.forEach(place => {
                    results.push({
                        type: 'online',
                        data: place
                    });
                });
            } catch (err) {
                console.error("OSM Search Error", err);
            }

            renderSearchResults(results);
        }

        function renderSearchResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">æ‰¾ä¸åˆ°ç›¸é—œçµæœ</div>';
                return;
            }

            results.forEach(res => {
                const div = document.createElement('div');
                div.className = "p-3 bg-white hover:bg-gray-50 border-b border-gray-100 cursor-pointer transition-colors";
                
                // Only online results now
                const p = res.data; // OSM data
                div.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="text-xl">ğŸ“</div>
                        <div>
                            <h4 class="font-bold text-sm text-gray-800">${p.name || p.display_name.split(',')[0]}</h4>
                            <p class="text-xs text-gray-500 truncate w-full max-w-[250px]">${p.display_name}</p>
                        </div>
                    </div>
                `;
                div.onclick = () => {
                    document.getElementById('searchModal').classList.add('hidden');
                    const lat = parseFloat(p.lat);
                    const lon = parseFloat(p.lon);
                    map.setView([lat, lon], 18);
                };
                container.appendChild(div);
            });
        }

        function startListening() {
            // Simplified collection path for personal project
            const q = query(collection(db, 'pikmin_spots'));
            onSnapshot(q, (snapshot) => {
                allPoints = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPoints();
                // Hide loading pill once data is loaded
                const loader = document.getElementById('dataLoadingIndicator');
                if (loader) loader.classList.add('opacity-0', 'pointer-events-none');
                
                updateCounts();
            }, (err) => {
                console.error("Snapshot error", err);
                const loader = document.getElementById('dataLoadingIndicator');
                if (loader) {
                     loader.innerHTML = '<span class="text-red-500">è®€å–å¤±æ•—</span>';
                }
                
                // Specific handling for permission errors
                if (err.code === 'permission-denied') {
                    alert("âš ï¸ è³‡æ–™åº«æ¬Šé™ä¸è¶³ï¼\n\næ‚¨ä¼¼ä¹æˆåŠŸç™»å…¥äº†ï¼Œä½†è¢«è³‡æ–™åº«æ‹’çµ•è®€å–ã€‚\nè«‹å›åˆ° Firebase Console > Firestore Database > Rules (è¦å‰‡)ï¼Œç¢ºèªæ‚¨å·²å°‡è¦å‰‡æ”¹ç‚ºï¼š\nallow read, write: if request.auth != null;");
                }
            });
        }

        function showModal(isEdit = false) {
            const modal = document.getElementById('addModal');
            const title = document.getElementById('modalTitle');
            const btn = document.getElementById('modalSubmitBtn');
            
            if (isEdit) {
                title.textContent = "ç·¨è¼¯é£¾å“é»";
                btn.textContent = "å„²å­˜è®Šæ›´";
                isEditingMode = true;
            } else {
                title.textContent = "æ–°å¢é£¾å“é»";
                btn.textContent = "ç¢ºèªæ–°å¢";
                isEditingMode = false;
                editPointId = null;
            }
            
            modal.classList.remove('hidden');
            document.getElementById('instructionBanner').classList.add('hidden');
        }

        function handleEditPoint(point) {
            // Close popup first if open
            map.closePopup();
            
            // Set state
            editPointId = point.id;
            
            // Create temp marker at existing position for visual reference
            if (tempMarker) map.removeLayer(tempMarker);
            const defaultIcon = createLeafletIcon(CATEGORIES[point.category]?.icon || CATEGORIES.restaurant.icon);
            tempMarker = L.marker([point.lat, point.lng], { icon: defaultIcon, opacity: 0.7 }).addTo(map);
            
            // Populate form
            document.getElementById('pointName').value = point.name || '';
            document.getElementById('pointCategory').value = point.category || 'restaurant';
            document.getElementById('pointDesc').value = point.description || '';
            document.getElementById('pointCoords').value = `${point.lat}, ${point.lng}`;
            
            // Show modal in Edit mode
            showModal(true);
        }

        // --- Address Copy & Redirect Logic ---
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            
            toast.classList.remove('toast-visible');
            void toast.offsetWidth; // Trigger reflow
            
            toastMsg.textContent = message;
            toast.classList.add('toast-visible');
        }

        function copyToClipboard(text) {
            const textarea = document.createElement("textarea");
            textarea.value = text;
            textarea.style.position = "fixed";
            textarea.style.left = "-9999px";
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand("copy");
            } catch (err) {
                console.error("Fallback copy failed", err);
            }
            
            document.body.removeChild(textarea);
        }

        function promptRedirect(lat, lng) {
            redirectLatLng = { lat, lng };
            const modal = document.getElementById('mapRedirectModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function cancelRedirect() {
            const modal = document.getElementById('mapRedirectModal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                redirectLatLng = null;
            }, 300);
        }

        function confirmRedirect() {
            if (!redirectLatLng) return;
            // Google Maps URL Scheme that works on both web and mobile apps
            const url = `https://www.google.com/maps/search/?api=1&query=${redirectLatLng.lat},${redirectLatLng.lng}`;
            window.open(url, '_blank');
            cancelRedirect();
        }

        async function handleCopyAddress(lat, lng) {
            // Optimization: Prompt immediately for redirection to avoid waiting for API
            promptRedirect(lat, lng);

            showToast("æ­£åœ¨å–å¾—åœ°å€...");
            
            try {
                // Fetch address from OSM Nominatim
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, {
                    headers: { 'Accept-Language': 'zh-TW' }
                });
                
                if (!response.ok) throw new Error("Network response was not ok");
                
                const data = await response.json();
                
                let addressToCopy = "";
                if (data && data.display_name) {
                    addressToCopy = data.display_name;
                } else {
                    addressToCopy = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                }

                copyToClipboard(addressToCopy);
                showToast("å·²è¤‡è£½åœ°å€");

                // Note: We already prompted redirect at the start, no need to prompt again

            } catch (error) {
                console.error("Geocoding failed", error);
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                copyToClipboard(mapLink);
                showToast("å·²è¤‡è£½åœ°åœ–é€£çµ");
                
                // Note: We already prompted redirect at the start
            }
        }

        // --- Existing Helper Functions ---

        function promptDelete(id) {
            pointToDeleteId = id;
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function cancelDelete() {
            const modal = document.getElementById('deleteModal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                pointToDeleteId = null;
            }, 300);
        }

        async function confirmDelete() {
            if (!pointToDeleteId) return;
            
            // 1. Close UI immediately (Optimistic UX)
            const idToDelete = pointToDeleteId;
            cancelDelete();
            
            showToast("æ­£åœ¨åˆªé™¤...");

            try {
                // Simplified collection path for personal project
                const docRef = doc(db, 'pikmin_spots', idToDelete);
                await deleteDoc(docRef);
                showToast("åˆªé™¤æˆåŠŸ");
            } catch (error) {
                console.error("Error removing document: ", error);
                showToast("åˆªé™¤å¤±æ•—");
            }
        }

        function renderPoints() {
            markersLayer.clearLayers();
            
            // Updated filtering logic for multiple categories and modes
            let pointsToShow = [];
            
            if (!isExcludeMode) {
                // Include Mode: Show if in set (or set has all)
                pointsToShow = currentFilters.has('all') 
                    ? allPoints 
                    : allPoints.filter(p => currentFilters.has(p.category));
            } else {
                // Exclude Mode: Show if NOT in set (assuming 'all' means hide none)
                pointsToShow = currentFilters.has('all') 
                    ? allPoints 
                    : allPoints.filter(p => !currentFilters.has(p.category));
            }

            pointsToShow.forEach(p => {
                const cat = CATEGORIES[p.category] || CATEGORIES.other;
                const icon = createLeafletIcon(cat.icon);
                
                const container = document.createElement('div');
                container.className = "font-sans text-center min-w-[160px]";
                
                container.innerHTML = `
                    <div class="text-3xl mb-1">${cat.icon}</div>
                    <h3 class="font-bold text-gray-800 text-sm mb-1">${p.name}</h3>
                    <div class="text-xs text-blue-600 bg-blue-50 inline-block px-2 py-0.5 rounded-full mb-3">${cat.label}</div>
                    ${p.description ? `<p class="text-xs text-gray-500 text-left border-t border-gray-100 pt-2 mb-2">${p.description}</p>` : ''}
                `;

                // Wrapper for buttons
                const btnWrapper = document.createElement('div');
                btnWrapper.className = "border-t border-gray-100 pt-2 flex flex-col gap-1";

                // Copy Address Button
                const copyBtn = document.createElement('button');
                copyBtn.className = "flex items-center justify-center gap-1.5 w-full py-1.5 text-xs font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 rounded-md transition-colors";
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    è¤‡è£½åœ°å€
                `;
                copyBtn.onclick = (e) => {
                    e.stopPropagation();
                    handleCopyAddress(p.lat, p.lng);
                };
                btnWrapper.appendChild(copyBtn);

                // Edit Button (New) & Delete Button (Only for authenticated user in this demo)
                if (currentUser) {
                    const actionRow = document.createElement('div');
                    actionRow.className = "flex gap-2 mt-1";

                    // Edit Button
                    const editBtn = document.createElement('button');
                    editBtn.className = "flex-1 flex items-center justify-center gap-1 py-1 text-xs text-blue-500 hover:text-blue-700 hover:bg-blue-50 rounded-md transition-colors";
                    editBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        ç·¨è¼¯
                    `;
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        handleEditPoint(p);
                    };
                    actionRow.appendChild(editBtn);

                    // Delete Button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = "flex-1 flex items-center justify-center gap-1 py-1 text-xs text-red-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors";
                    deleteBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        åˆªé™¤
                    `;
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        promptDelete(p.id);
                    };
                    actionRow.appendChild(deleteBtn);

                    btnWrapper.appendChild(actionRow);
                }

                container.appendChild(btnWrapper);

                const marker = L.marker([p.lat, p.lng], { icon: icon }).bindPopup(container);
                markersLayer.addLayer(marker);
            });
        }

        function toggleAddMode() {
            isAddingMode = !isAddingMode;
            const btn = document.getElementById('addPointBtn');
            const btnText = document.getElementById('addBtnText');
            const banner = document.getElementById('instructionBanner');
            const sidebar = document.getElementById('sidebar');

            if (isAddingMode) {
                // Entering add mode
                btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg><span>å–æ¶ˆ</span>`;
                banner.classList.remove('hidden');
                sidebar.classList.add('-translate-x-full'); // Hide sidebar on mobile
                
                // Change cursor
                document.getElementById('map').style.cursor = 'crosshair';
            } else {
                // Exiting add mode
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span>æ–°å¢åœ°é»</span>`;
                banner.classList.add('hidden');
                document.getElementById('addModal').classList.add('hidden');
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                document.getElementById('map').style.cursor = '';
            }
        }

        function createLeafletIcon(emoji) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: white; 
                    border: 2px solid white; 
                    border-radius: 50%; 
                    width: 32px; 
                    height: 32px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                    font-size: 20px;
                ">${emoji}</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        }

        function updateTempMarkerIcon(categoryKey) {
            if (!tempMarker) return;
            const cat = CATEGORIES[categoryKey] || CATEGORIES.other;
            tempMarker.setIcon(createLeafletIcon(cat.icon));
        }

        function createCategoryBtn(id, data, isActive = false) {
            const btn = document.createElement('button');
            btn.className = `w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm transition-colors cat-btn text-gray-600 hover:bg-gray-50`;
            btn.dataset.id = id;
            
            const countSpan = id === 'all' 
                ? `<span class="count-badge ml-auto text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">0</span>`
                : `<span class="count-badge ml-auto text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">0</span>`;

            btn.innerHTML = `
                <div class="w-8 text-center text-lg">${data.icon}</div>
                <span>${data.label}</span>
                ${countSpan}
            `;

            btn.addEventListener('click', () => {
                if (id === 'all') {
                    // Reset to show all
                    currentFilters.clear();
                    currentFilters.add('all');
                } else {
                    // Toggle logic
                    if (currentFilters.has('all')) {
                        currentFilters.delete('all');
                    }
                    
                    if (currentFilters.has(id)) {
                        currentFilters.delete(id);
                    } else {
                        currentFilters.add(id);
                    }

                    // If nothing selected, revert to 'all'
                    if (currentFilters.size === 0) {
                        currentFilters.add('all');
                    }
                }
                
                updateCategoryButtonsState();
                renderPoints();

                // New Logic: Fly to nearest
                if (id !== 'all' && currentFilters.has(id) && !isExcludeMode && currentUserPosition) {
                    const categoryPoints = allPoints.filter(p => p.category === id);
                    if (categoryPoints.length > 0) {
                        let nearestPoint = null;
                        let minDistance = Infinity;

                        categoryPoints.forEach(p => {
                            const dist = map.distance(currentUserPosition, [p.lat, p.lng]);
                            if (dist < minDistance) {
                                minDistance = dist;
                                nearestPoint = p;
                            }
                        });

                        if (nearestPoint) {
                            map.setView([nearestPoint.lat, nearestPoint.lng], 16); 
                            showToast(`å·²ç§»å‹•åˆ°æœ€è¿‘çš„ ${CATEGORIES[id].label}`);
                        }
                    }
                }
            });

            return btn;
        }
        
        function updateCategoryButtonsState() {
            document.querySelectorAll('.cat-btn').forEach(btn => {
                const id = btn.dataset.id;
                const isActive = currentFilters.has(id);
                
                // Reset classes
                btn.classList.remove(
                    'bg-blue-50', 'text-blue-700', 
                    'bg-red-50', 'text-red-700', 
                    'font-medium', 'text-gray-600', 'hover:bg-gray-50'
                );

                if (isActive) {
                    if (isExcludeMode) {
                        // Exclude Mode: Active = Red (Hidden)
                        btn.classList.add('bg-red-50', 'text-red-700', 'font-medium');
                    } else {
                        // Include Mode: Active = Blue (Shown)
                        btn.classList.add('bg-blue-50', 'text-blue-700', 'font-medium');
                    }
                } else {
                    btn.classList.add('text-gray-600', 'hover:bg-gray-50');
                }
            });
        }

        function updateCounts() {
            // Updated to reflect "visible on map" counts based on current filter mode logic?
            // Actually, usually counts show total available points for that category.
            // Let's stick to total available points as it's less confusing for the sidebar.
            
            const allBtn = document.querySelector(`.cat-btn[data-id="all"] .count-badge`);
            if(allBtn) allBtn.textContent = allPoints.length;

            Object.keys(CATEGORIES).forEach(key => {
                const btn = document.querySelector(`.cat-btn[data-id="${key}"] .count-badge`);
                if(btn) {
                    const count = allPoints.filter(p => p.category === key).length;
                    btn.textContent = count;
                }
            });
        }

        // Run
        init();

    </script>
</body>
</html>
